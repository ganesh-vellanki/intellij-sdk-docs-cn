


<!doctype html>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <title>Implementing a Parser and PSI / IntelliJ Platform SDK  DevGuide</title>
    <link rel="stylesheet" href="/app/app.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">
    <link rel="mask-icon" href="/apple-mask-icon.svg" color="black">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-square70x70logo" content="/mstile-70x70.png">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="msapplication-square150x150logo" content="/mstile-150x150.png">
    <meta name="msapplication-wide310x150logo" content="/mstile-310x150.png">
    <meta name="msapplication-square310x310logo" content="/mstile-310x310.png">
    <meta name="theme-color" content="#000000">
    <meta name="description" content="Documentation for working with and extending the IntelliJ Platform SDK" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://intellij-sdk-docs-cn.github.io//reference_guide/custom_language_support/implementing_parser_and_psi.html" />
    <meta property="og:site_name" content="JetBrains IntelliJ Platform SDK" />
    <meta property="og:title" content="Implementing a Parser and PSI" />
    <meta property="og:description" content="Documentation for working with and extending the IntelliJ Platform SDK" />
    <meta property="og:image" content="https://intellij-sdk-docs-cn.github.io/jetbrains.png" />
    <meta property="article:modified_time" content="2020-02-19T22:25:03+08:00" />
    <!-- <meta property="article:section" content="" /> 
    <meta property="article:tag" content="" /> -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@JBPlatform" />
    <meta name="twitter:title" content="Implementing a Parser and PSI" />
    <meta name="twitter:description" content="Documentation for working with and extending the IntelliJ Platform SDK" />
    <meta name="twitter:image" content="https://intellij-sdk-docs-cn.github.io/jetbrains.png" />
    <meta class="swiftype" name="product" data-type="string" content="/"></meta>
<link  rel="stylesheet" href="/app/styles.css"></head>
<body data-id="reference_guide/custom_language_support/implementing_parser_and_psi">
<div class="wrapper">
    <section class="panel _nav">
        <header class="panel__header">
            <div class="container">
                <form class="search-box">
                    <label for="search-box__input" class="search-box__label">
                        <input type="text" class="search-box__input" id="search-box__input" placeholder="Search IntelliJ Platform SDK  DevGuide">
                    </label>
                    <div class="search-box__clear" title="Clear"></div>
                </form>
            </div>
        </header>
        <nav class="panel__content">
            <div class="container _nav">
                <menu class="nav-tree"></menu>
            </div>
            <div class="container _footer panel__footer">
                <p><a data-bypass="true" href="//youtrack.jetbrains.com/issues/IJSDK">Send feedback</a></p>
                <p>&copy; 2000&ndash;2020 <a href="//www.jetbrains.com">JetBrains</a> s.r.o.<br>
                    All rights reserved.</p>
            </div>
        </nav>
    </section>

    <main class="panel _main" role="main">
        <header class="panel__header">
            <div class="container">
                <h3>IntelliJ Platform SDK DevGuide</h3>
                
                <div class="panel-trigger"></div>
            </div>
        </header>
        <section class="panel__content">
            <div class="container">
                <article class="article" data-shortcut-switcher="false">
                    <div class="navigation-links _top" data-swiftype-index="false">
                        <a class="navigation-links__prev" href="/reference_guide/custom_language_support/implementing_lexer.html">Implementing Lexer</a>
                        <a class="navigation-links__next" href="/reference_guide/custom_language_support/syntax_highlighting_and_error_highlighting.html">Syntax Highlighting and Error Highlighting</a>
                    </div>
                    <a data-bypass="true" href="https://github.com/intellij-sdk-docs-cn/intellij-sdk-docs-cn/edit/master/reference_guide/custom_language_support/implementing_parser_and_psi.md" class="page-link-to-github" target="_blank" title="Edit this page on GitHub">
                        <i class="github-icon"></i>
                        <span class="text">Edit page</span>
                    </a>

                    <h1>Implementing a Parser and PSI</h1>
                    <!-- Copyright 2000-2020 JetBrains s.r.o. and other contributors. Use of this source code is governed by the Apache 2.0 license that can be found in the LICENSE file. -->

<p>Parsing files in IntelliJ Platform is a two-step process.
First, an abstract syntax tree (AST) is built, defining the structure of the program.
AST nodes are created internally by the IDE and are represented by instances of the
<a href="https://upsource.jetbrains.com/idea-ce/file/idea-ce-e2d423f42b53eafd5c625b93149a0ebc7e49756c/platform/core-api/src/com/intellij/lang/ASTNode.java" data-bypass="yes" target="_blank"><span><code class="code highlight language-text">ASTNode</code></span></a>
class.
Each AST node has an associated element type
<a href="https://upsource.jetbrains.com/idea-ce/file/idea-ce-e2d423f42b53eafd5c625b93149a0ebc7e49756c/platform/core-api/src/com/intellij/psi/tree/IElementType.java" data-bypass="yes" target="_blank"><span><code class="code highlight language-text">IElementType</code></span></a>
instance, and the element types are defined by the language plugin.
The top-level node of the AST tree for a file needs to have a special element type, implementing the
<a href="https://upsource.jetbrains.com/idea-ce/file/idea-ce-e2d423f42b53eafd5c625b93149a0ebc7e49756c/platform/core-api/src/com/intellij/psi/tree/IFileElementType.java" data-bypass="yes" target="_blank"><span><code class="code highlight language-text">IFileElementType</code></span></a>
interface.</p>

<p>The AST nodes have a direct mapping to text ranges in the underlying document.
The bottom-most nodes of the AST match individual tokens returned by the lexer, and higher level nodes match multiple-token fragments.
Operations performed on nodes of the AST tree, such as inserting, removing, reordering nodes and so on, are immediately reflected as changes to the text of the underlying document.</p>

<p>Second, a PSI, or Program Structure Interface, tree is built on top of the AST, adding semantics and methods for manipulating specific language constructs.
Nodes of the PSI tree are represented by classes implementing the
<a href="https://upsource.jetbrains.com/idea-ce/file/idea-ce-e2d423f42b53eafd5c625b93149a0ebc7e49756c/platform/core-api/src/com/intellij/psi/PsiElement.java" data-bypass="yes" target="_blank"><span><code class="code highlight language-text">PsiElement</code></span></a>
interface and are created by the language plugin in the
<a href="https://upsource.jetbrains.com/idea-ce/file/idea-ce-e2d423f42b53eafd5c625b93149a0ebc7e49756c/platform/core-api/src/com/intellij/lang/ParserDefinition.java" data-bypass="yes" target="_blank"><span><code class="code highlight language-text">ParserDefinition.createElement()</code></span></a>
method.
The top-level node of the PSI tree for a file needs to implement the
<a href="https://upsource.jetbrains.com/idea-ce/file/idea-ce-e2d423f42b53eafd5c625b93149a0ebc7e49756c/platform/core-api/src/com/intellij/psi/PsiFile.java" data-bypass="yes" target="_blank"><span><code class="code highlight language-text">PsiFile</code></span></a>
interface, and is created in the
<a href="https://upsource.jetbrains.com/idea-ce/file/idea-ce-e2d423f42b53eafd5c625b93149a0ebc7e49756c/platform/core-api/src/com/intellij/lang/ParserDefinition.java" data-bypass="yes" target="_blank"><span><code class="code highlight language-text">ParserDefinition.createFile()</code></span></a>
method.</p>

<p><strong>Example</strong>:
<a href="https://upsource.jetbrains.com/idea-ce/file/idea-ce-e2d423f42b53eafd5c625b93149a0ebc7e49756c/plugins/properties/properties-psi-impl/src/com/intellij/lang/properties/parsing/PropertiesParserDefinition.java" data-bypass="yes" target="_blank"><span><code class="code highlight language-text">ParserDefinition</code></span></a>
for
<a href="https://upsource.jetbrains.com/idea-ce/file/idea-ce-e2d423f42b53eafd5c625b93149a0ebc7e49756c/plugins/properties" data-bypass="yes" target="_blank"><span>Properties language plugin</span></a></p>

<p>The lifecycle of the PSI is described in more detail in <a href="/platform/fundamentals.html"><span>Fundamentals</span></a>.</p>

<p>The base classes for the PSI implementation, including
<a href="https://upsource.jetbrains.com/idea-ce/file/idea-ce-e2d423f42b53eafd5c625b93149a0ebc7e49756c/platform/core-impl/src/com/intellij/extapi/psi/PsiFileBase.java" data-bypass="yes" target="_blank"><span><code class="code highlight language-text">PsiFileBase</code></span></a>,
the base implementation of
<a href="https://upsource.jetbrains.com/idea-ce/file/idea-ce-e2d423f42b53eafd5c625b93149a0ebc7e49756c/platform/core-api/src/com/intellij/psi/PsiFile.java" data-bypass="yes" target="_blank"><span><code class="code highlight language-text">PsiFile</code></span></a>,
and
<a href="https://upsource.jetbrains.com/idea-ce/file/idea-ce-e2d423f42b53eafd5c625b93149a0ebc7e49756c/platform/core-impl/src/com/intellij/extapi/psi/ASTWrapperPsiElement.java" data-bypass="yes" target="_blank"><span><code class="code highlight language-text">ASTWrapperPsiElement</code></span></a>,
the base implementation of
<a href="https://upsource.jetbrains.com/idea-ce/file/idea-ce-e2d423f42b53eafd5c625b93149a0ebc7e49756c/platform/core-api/src/com/intellij/psi/PsiElement.java" data-bypass="yes" target="_blank"><span><code class="code highlight language-text">PsiElement</code></span></a>,
are provided by <em>IntelliJ Platform</em>.</p>

<p>While coding parser manually is quite possible, we highly recommend generating parser and corresponding PSI classes from grammars using
<a href="https://plugins.jetbrains.com/plugin/6606-grammar-kit" data-bypass="yes" target="_blank"><span>Grammar-Kit</span></a> plugin.
Besides code generation, it provides various features for editing grammar files: syntax highlighting, quick navigation, refactorings, and more.
The Grammar-Kit plugin is built using its own engine; its source code can be found on
<a href="https://github.com/JetBrains/Grammar-Kit" data-bypass="yes" target="_blank"><span>GitHub</span></a>.</p>

<p>For re-using existing ANTLRv4 grammars, see <a href="https://github.com/antlr/antlr4-intellij-adaptor" data-bypass="yes" target="_blank"><span>antlr4-intellij-adaptor</span></a> library.</p>

<p>The language plugin provides the parser implementation as an implementation of the
<a href="https://upsource.jetbrains.com/idea-ce/file/idea-ce-e2d423f42b53eafd5c625b93149a0ebc7e49756c/platform/core-api/src/com/intellij/lang/PsiParser.java" data-bypass="yes" target="_blank"><span><code class="code highlight language-text">PsiParser</code></span></a>
interface, returned from
<a href="https://upsource.jetbrains.com/idea-ce/file/idea-ce-e2d423f42b53eafd5c625b93149a0ebc7e49756c/platform/core-api/src/com/intellij/lang/ParserDefinition.java" data-bypass="yes" target="_blank"><span><code class="code highlight language-text">ParserDefinition.createParser()</code></span></a>.
The parser receives an instance of the
<a href="https://upsource.jetbrains.com/idea-ce/file/idea-ce-e2d423f42b53eafd5c625b93149a0ebc7e49756c/platform/core-api/src/com/intellij/lang/PsiBuilder.java" data-bypass="yes" target="_blank"><span><code class="code highlight language-text">PsiBuilder</code></span></a>
class, which is used to get the stream of tokens from the lexer and to hold the intermediate state of the AST being built.
The parser must process all tokens returned by the lexer up to the end of stream, in other words until
<a href="https://upsource.jetbrains.com/idea-ce/file/idea-ce-e2d423f42b53eafd5c625b93149a0ebc7e49756c/platform/core-api/src/com/intellij/lang/PsiBuilder.java" data-bypass="yes" target="_blank"><span><code class="code highlight language-text">PsiBuilder.getTokenType()</code></span></a>
returns <code class="code highlight language-text">null</code>, even if the tokens are not valid according to the language syntax.</p>

<p><strong>Example</strong>:
<a href="https://upsource.jetbrains.com/idea-ce/file/idea-ce-e2d423f42b53eafd5c625b93149a0ebc7e49756c/plugins/properties/properties-psi-impl/src/com/intellij/lang/properties/parsing/PropertiesParser.java" data-bypass="yes" target="_blank"><span><code class="code highlight language-text">PsiParser</code></span></a>
implementation for
<a href="https://upsource.jetbrains.com/idea-ce/file/idea-ce-e2d423f42b53eafd5c625b93149a0ebc7e49756c/plugins/properties/properties-psi-impl/src/com/intellij/lang/properties/" data-bypass="yes" target="_blank"><span>Properties language plugin</span></a>.</p>

<p>The parser works by setting pairs of markers (
<a href="https://upsource.jetbrains.com/idea-ce/file/idea-ce-e2d423f42b53eafd5c625b93149a0ebc7e49756c/platform/core-api/src/com/intellij/lang/PsiBuilder.java" data-bypass="yes" target="_blank"><span><code class="code highlight language-text">PsiBuilder.Marker</code></span></a>
instances) within the stream of tokens received from the lexer.
Each pair of markers defines the range of lexer tokens for a single node in the AST tree.
If a pair of markers is nested in another pair (starts after its start and ends before its end), it becomes the child node of the outer pair.</p>

<p>The element type for the marker pair and for the AST node created from it is specified when the end marker is set, which is done by making call to
<a href="https://upsource.jetbrains.com/idea-ce/file/idea-ce-e2d423f42b53eafd5c625b93149a0ebc7e49756c/platform/core-api/src/com/intellij/lang/PsiBuilder.java" data-bypass="yes" target="_blank"><span><code class="code highlight language-text">PsiBuilder.Marker.done()</code></span></a>.
Also, it is possible to drop a start marker before its end marker has been set.
The <code class="code highlight language-text">drop()</code> method drops only a single start marker without affecting any markers added after it, and the <code class="code highlight language-text">rollbackTo()</code> method drops the start marker and all markers added after it and reverts the lexer position to the start marker.
These methods can be used to implement lookahead when parsing.</p>

<p>The method
<a href="https://upsource.jetbrains.com/idea-ce/file/idea-ce-e2d423f42b53eafd5c625b93149a0ebc7e49756c/platform/core-api/src/com/intellij/lang/PsiBuilder.java" data-bypass="yes" target="_blank"><span><code class="code highlight language-text">PsiBuilder.Marker.precede()</code></span></a>
is useful for right-to-left parsing when you don’t know how many markers you need at a certain position until you read more input.
For example, a binary expression <code class="code highlight language-text">a+b+c</code> needs to be parsed as <code class="code highlight language-text">( (a+b) + c )</code>.
Thus, two start markers are needed at the position of the token ‘a’, but that is not known until the token ‘c’ is read.
When the parser reaches the ‘+’ token following ‘b’, it can call <code class="code highlight language-text">precede()</code> to duplicate the start marker at ‘a’ position, and then put its matching end marker after ‘c’.</p>

<p>An important feature of
<a href="https://upsource.jetbrains.com/idea-ce/file/idea-ce-e2d423f42b53eafd5c625b93149a0ebc7e49756c/platform/core-api/src/com/intellij/lang/PsiBuilder.java" data-bypass="yes" target="_blank"><span><code class="code highlight language-text">PsiBuilder</code></span></a>
is its handling of whitespace and comments.
The types of tokens which are treated as whitespace or comments are defined by the methods <code class="code highlight language-text">getWhitespaceTokens()</code> and <code class="code highlight language-text">getCommentTokens()</code> in the
<a href="https://upsource.jetbrains.com/idea-ce/file/idea-ce-e2d423f42b53eafd5c625b93149a0ebc7e49756c/platform/core-api/src/com/intellij/lang/ParserDefinition.java" data-bypass="yes" target="_blank"><span><code class="code highlight language-text">ParserDefinition</code></span></a>
class.
<a href="https://upsource.jetbrains.com/idea-ce/file/idea-ce-e2d423f42b53eafd5c625b93149a0ebc7e49756c/platform/core-api/src/com/intellij/lang/PsiBuilder.java" data-bypass="yes" target="_blank"><span><code class="code highlight language-text">PsiBuilder</code></span></a>
automatically omits whitespace and comment tokens from the stream of tokens it passes to
<a href="https://upsource.jetbrains.com/idea-ce/file/idea-ce-e2d423f42b53eafd5c625b93149a0ebc7e49756c/platform/core-api/src/com/intellij/lang/PsiParser.java" data-bypass="yes" target="_blank"><span><code class="code highlight language-text">PsiParser</code></span></a>,
and adjusts the token ranges of AST nodes so that leading and trailing whitespace tokens are not included in the node.</p>

<p>The token set returned from
<a href="https://upsource.jetbrains.com/idea-ce/file/idea-ce-e2d423f42b53eafd5c625b93149a0ebc7e49756c/platform/core-api/src/com/intellij/lang/ParserDefinition.java" data-bypass="yes" target="_blank"><span><code class="code highlight language-text">ParserDefinition.getCommentTokens()</code></span></a>
is also used to search for TODO items.</p>

<p>In order to better understand the process of building a PSI tree for a simple expression, you can refer to the following diagram:</p>

<p><img src="img/PsiBuilder.gif" alt="PsiBuilder" /></p>

<p>In general, there is no single right way to implement a PSI for a custom language, and the plugin author can choose the PSI structure and set of methods which are the most convenient for the code which uses the PSI (error analysis, refactorings and so on).
However, there is one base interface which needs to be used by a custom language PSI implementation in order to support features like rename and find usages.
Every element which can be renamed or referenced (a class definition, a method definition and so on) needs to implement the
<a href="https://upsource.jetbrains.com/idea-ce/file/idea-ce-e2d423f42b53eafd5c625b93149a0ebc7e49756c/platform/core-api/src/com/intellij/psi/PsiNamedElement.java" data-bypass="yes" target="_blank"><span><code class="code highlight language-text">PsiNamedElement</code></span></a>
interface, with methods <code class="code highlight language-text">getName()</code> and <code class="code highlight language-text">setName()</code>.</p>

<p>A number of functions which can be used for implementing and using the PSI can be found in the <code class="code highlight language-text">com.intellij.psi.util</code> package, and in particular in the
<a href="https://upsource.jetbrains.com/idea-ce/file/idea-ce-e2d423f42b53eafd5c625b93149a0ebc7e49756c/java/java-psi-api/src/com/intellij/psi/util/PsiUtil.java" data-bypass="yes" target="_blank"><span><code class="code highlight language-text">PsiUtil</code></span></a>
and
<a href="https://upsource.jetbrains.com/idea-ce/file/idea-ce-e2d423f42b53eafd5c625b93149a0ebc7e49756c/platform/core-api/src/com/intellij/psi/util/PsiTreeUtil.java" data-bypass="yes" target="_blank"><span><code class="code highlight language-text">PsiTreeUtil</code></span></a>
classes.</p>

<p>A very helpful tool for debugging the PSI implementation is the
<a href="https://plugins.jetbrains.com/plugin/227-psiviewer" data-bypass="yes" target="_blank"><span>PsiViewer plugin</span></a>.
It can show you the structure of the PSI built by your plugin, the properties of every PSI element and highlight its text range.</p>

<p>Please see
<a href="/basics/indexing_and_psi_stubs.html"><span>Indexing and PSI Stubs</span></a>
for advanced topics.</p>


                    <div class="navigation-links _bottom" data-swiftype-index="false">
                        <a class="navigation-links__prev" href="/reference_guide/custom_language_support/implementing_lexer.html">Implementing Lexer</a>
                        <a class="navigation-links__next" href="/reference_guide/custom_language_support/syntax_highlighting_and_error_highlighting.html">Syntax Highlighting and Error Highlighting</a>
                    </div>
                    <div class="last-modified">
                        Last modified: 19 February 2020
                    </div>
                </article>

                <section class="disqus">
                    <div id="disqus_thread"></div>
                </section>
            </div>
        </section>
    </main>
</div>

<script src="/app/app.js" data-baseurl="/"></script>

</body>
</html>

